@page "/api/asistencia"
@using AppAsisten.Shared.DTO
@inject IHttpServicio HttpServicio

<h3>Registrar Asistencia</h3>

<div>
    <label for="codigoQR">Código QR:</label>
    <input type="text" id="codigoQR" @bind="codigoQR" />

    <button @onclick="RegistrarEntrada">Registrar Entrada</button>
    <button @onclick="RegistrarSalida">Registrar Salida</button>
</div>

@if (asistencia != null)
{
    <div>
        <h4>Asistencia Registrada</h4>
        <p><strong>Miembro:</strong> @asistencia.Miembro.Nombre</p>
        <p><strong>Entrada:</strong> @asistencia.Asistencia.Entrada</p>
        @if (asistencia.Asistencia.Salida.HasValue)
        {
            <p><strong>Salida:</strong> @asistencia.Asistencia.Salida</p>
        }
        else
        {
            <p><strong>Salida:</strong> Pendiente</p>
        }
    </div>
}

@if (!string.IsNullOrEmpty(errorMessage))
{
    <p class="text-danger">@errorMessage</p>
}

@code {
    private string codigoQR;
    private AsistenciaRespuestaDTO asistencia;
    private string errorMessage;

    private async Task RegistrarEntrada()
    {
        try
        {
            var respuesta = await HttpServicio.Post(codigoQR, "api/Asistencia/entrada");

            if (respuesta.Error)
            {
                // Obtener mensaje de error
                errorMessage = await respuesta.ObtenerError();
                asistencia = null;
            }
            else
            {
                errorMessage = string.Empty;
            }
        }
        catch (Exception ex)
        {
            asistencia = null;
            errorMessage = $"Error: {ex.Message}";
        }
    }

    private async Task RegistrarSalida()
    {
        try
        {
            var respuesta = await HttpServicio.Post(codigoQR, "api/Asistencia/salida");

            if (respuesta.Error)
            {
                errorMessage = await respuesta.ObtenerError();
                asistencia = null;
            }
            else
            {
                errorMessage = string.Empty;
            }
        }
        catch (Exception ex)
        {
            asistencia = null;
            errorMessage = $"Error: {ex.Message}";
        }
    }
}
