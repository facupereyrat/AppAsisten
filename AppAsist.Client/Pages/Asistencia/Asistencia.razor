@page "/asistencia"
@page "/asistencia/{codigo}"  // ← NUEVA RUTA CON PARÁMETRO
@inject HttpClient Http
@inject NavigationManager Navigation  // ← AGREGÁ ESTO
@using AppAsisten.Shared.DTO
@using System.Net.Http.Json

<h3>Registrar Asistencia</h3>

<div class="mb-3">
    <label for="codigoQR">Código QR:</label>
    <input type="text" id="codigoQR" @bind="codigoQR" class="form-control" />
</div>

<div class="mb-3">
    <button class="btn btn-primary" @onclick="Registrar">Registrar</button>
</div>

@if (!string.IsNullOrEmpty(mensajeError))
{
    <div class="alert alert-danger">
        @mensajeError
    </div>
}

@if (asistenciaRespuesta != null)
{
    <div class="mt-3 alert alert-success">
        <h5>
            @(asistenciaRespuesta.EsEntrada
                    ? "Entrada registrada correctamente" 
                                            : "Salida registrada correctamente")
        </h5>

        <p><strong>Miembro:</strong> @asistenciaRespuesta.Miembro?.Nombre</p>
        <p><strong>Entrada:</strong> @asistenciaRespuesta.Entrada</p>
        <p><strong>Salida:</strong> @(asistenciaRespuesta.Salida?.ToString() ?? "No registrada aún")</p>
    </div>
}

@code {
    private string codigoQR;
    private AsistenciaRespuestaDTO asistenciaRespuesta;
    private string mensajeError;

    // 👇 NUEVO: Parámetro que viene de la URL
    [Parameter]
    public string? codigo { get; set; }

    // 👇 NUEVO: Cuando la página se carga
    protected override void OnInitialized()
    {
        if (!string.IsNullOrEmpty(codigo))
        {
            codigoQR = codigo;
            // Llamamos a Registrar pero necesitamos que sea async
            _ = Task.Run(async () => await Registrar());
        }
    }

    private async Task Registrar()
    {
        mensajeError = null;
        asistenciaRespuesta = null;

        if (string.IsNullOrWhiteSpace(codigoQR))
            return;

        try
        {
            var response = await Http.PostAsJsonAsync("api/Asistencia/registrar", codigoQR);

            if (response.IsSuccessStatusCode)
            {
                asistenciaRespuesta = await response.Content.ReadFromJsonAsync<AsistenciaRespuestaDTO>();
                codigoQR = string.Empty;
            }
            else
            {
                mensajeError = await response.Content.ReadAsStringAsync();
            }
        }
        catch (Exception ex)
        {
            mensajeError = $"Error al registrar: {ex.Message}";
        }
    }
}