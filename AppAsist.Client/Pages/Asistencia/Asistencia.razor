@page "/asistencia"
@inject HttpClient Http
@using AppAsisten.Shared.DTO
@using System.Net.Http.Json

<h3>Registrar Asistencia</h3>

<div class="mb-3">
    <label for="codigoQR">Código QR:</label>
    <input type="text" id="codigoQR" @bind="codigoQR" class="form-control" />
</div>

<div class="mb-3">
    <button class="btn btn-primary" @onclick="Registrar">Registrar</button>
</div>

@if (!string.IsNullOrEmpty(mensajeError))
{
    <div class="alert alert-danger">
        @mensajeError
    </div>
}

@if (asistenciaRespuesta != null)
{
    <div class="mt-3 alert alert-success">
        <h5>
            @(asistenciaRespuesta.EsEntrada
                    ? "Entrada registrada correctamente" 
                                    : "Salida registrada correctamente")
        </h5>

        <p><strong>Miembro:</strong> @asistenciaRespuesta.Miembro?.Nombre</p>
        <p><strong>Entrada:</strong> @asistenciaRespuesta.Entrada</p>
        <p>
            <strong>Salida:</strong>
            @(asistenciaRespuesta.Salida?.ToString() ?? "No registrada aún")
        </p>
    </div>
}

@code {
    private string codigoQR;
    private AsistenciaRespuestaDTO asistenciaRespuesta;
    private string mensajeError;

    private async Task Registrar()
    {
        mensajeError = null;
        asistenciaRespuesta = null;

        if (string.IsNullOrWhiteSpace(codigoQR))
            return;

        try
        {
            var response = await Http.PostAsJsonAsync("api/Asistencia/registrar", codigoQR);

            if (response.IsSuccessStatusCode)
            {
                asistenciaRespuesta = await response.Content.ReadFromJsonAsync<AsistenciaRespuestaDTO>();
                codigoQR = string.Empty;
            }
            else
            {
                mensajeError = await response.Content.ReadAsStringAsync();
            }
        }
        catch (Exception ex)
        {
            mensajeError = $"Error al registrar: {ex.Message}";
        }
    }
}